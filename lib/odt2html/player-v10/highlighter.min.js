"use strict";var style=document.createElement("style");style.type="text/css";style.appendChild(document.createTextNode("\
	DIV.player_text SPAN.w:hover {outline: 1px black dotted} \
	DIV.player_text SPAN.highlighted {background-color: yellow} \
	"));document.head.appendChild(style);function Highlighter(player_id,scroller){var this_this=this;this.scroller=scroller;this.player_id=player_id;this.span_count=0;this.prev_paragraph=null;this.prev_word=null;this.scroll_remaining=0;this.scroll_timer=null;this.text_container=document.getElementById("Text"+player_id);this.text_container.className=this.text_container.className+" player_text";if(document.getElementById("W"+this.player_id+"0")===null)
this.span_words(this.text_container);var text_click_regexp=new RegExp('^W'+player_id+'(\\d+)$');this.text_click_closure=function(event){var match=event.target.id.match(text_click_regexp);if(match!==null){var word_index=parseInt(match[1]);parent.players.wordclick(word_index);}}
this.text_container.addEventListener('click',this.text_click_closure,false);}
Highlighter.prototype.span_words=function(el){var el=el.firstChild;while(el!==null){var next_el=el.nextSibling;if(el.nodeType===Node.TEXT_NODE){var frag=document.createDocumentFragment();var re=/([а-яёА-ЯЁ\ẃ]+)|([^а-яёА-ЯЁ\ẃ]+)/g;var text=el.nodeValue;var m;while(m=re.exec(text)){if(m[1]!==undefined){var span=document.createElement("span");span.id="W"+this.player_id+this.span_count;span.className="w";this.span_count++;span.appendChild(document.createTextNode(m[1]));frag.appendChild(span);}else{frag.appendChild(document.createTextNode(m[2]));}}
el.parentNode.replaceChild(frag,el);}else if(el.nodeType===Node.ELEMENT_NODE){this.span_words(el);}
el=next_el;}}
Highlighter.prototype.highlight=function(word_index){if(this.prev_word!==null){this.prev_word.className="w";this.prev_word=null;}
if(word_index!==null){var word=document.getElementById("W"+this.player_id+word_index);word.className="w highlighted";var paragraph=word.parentElement;if(paragraph!==this.prev_paragraph){console.log("scroll: new paragraph");var paragraph_middle=(paragraph.offsetTop+paragraph.offsetHeight/2);console.log("paragraph_middle="+paragraph_middle);var scroller_middle=(this.scroller.parentElement.offsetHeight/2-this.scroller.parentElement.offsetTop);console.log("scroller_middle="+scroller_middle);var scroll_target=(paragraph_middle-scroller_middle);console.log("scroll_target="+scroll_target);this.scroll_remaining=scroll_target>=0?Math.round(scroll_target-this.scroller.scrollTop):0;console.log("scroll_remaining="+this.scroll_remaining);if(this.scroll_remaining&&this.scroll_timer===null){var this_this=this;this.scroll_timer=setInterval(function(){if(this_this.scroll_remaining>0){this_this.scroller.scrollTop++;this_this.scroll_remaining--;}else if(this_this.scroll_remaining<0){this_this.scroller.scrollTop--;this_this.scroll_remaining++;}else{clearInterval(this_this.scroll_timer);this_this.scroll_timer=null;}},5);}
this.prev_paragraph=paragraph;}
this.prev_word=word;}}
Highlighter.prototype.close=function(){console.log("Closing highlighter...");this.highlight(null);this.text_container.className=this.text_container.className.replace(" player_text","");this.text_container.removeEventListener('click',this.text_click_closure,false);this.text_container=null;}